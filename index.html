<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat (Chatting-22bb9)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #e5ddd5; height: 100vh; display: flex; flex-direction: column; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: none; scroll-behavior: smooth; } 
        #input-area { background: #f0f0f0; padding: 10px; display: none; }
        
        /* Bubble Chat Styles */
        .message { max-width: 75%; padding: 10px 15px; margin-bottom: 10px; border-radius: 10px; position: relative; clear: both; word-wrap: break-word;}
        .message.me { background-color: #dcf8c6; float: right; border-top-right-radius: 0; text-align: right; }
        .message.them { background-color: #ffffff; float: left; border-top-left-radius: 0; text-align: left; }
        .message small { display: block; font-size: 0.7em; color: #888; margin-top: 5px; }

        #landing-page { height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="landing-page" class="container">
        <div class="card p-4 shadow text-center" style="max-width: 400px; width: 100%;">
            <h2 class="mb-3">ü§ê Private Chat</h2>
            <p class="text-muted">Server: Chatting-22bb9</p>
            <p>Klik tombol di bawah untuk membuat "Ruangan Rahasia".</p>
            <button onclick="createRoom()" class="btn btn-success btn-lg w-100">Buat Link Chat</button>
            <div class="mt-3">
                <small class="text-muted">Privasi terjaga. Link adalah kuncinya.</small>
            </div>
        </div>
    </div>

    <div id="top-bar" class="bg-success text-white p-3 shadow-sm" style="display:none;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span style="font-weight: bold; font-size: 1.1rem;">Secret Room</span>
                <br>
                <small id="room-id-display" style="opacity: 0.8; font-size: 0.8rem;">ID: -</small>
            </div>
            <button onclick="copyLink()" class="btn btn-sm btn-light text-success fw-bold">Salin Link üîó</button>
        </div>
    </div>

    <div id="chat-container">
        </div>

    <div id="input-area" class="fixed-bottom">
        <div class="input-group">
            <input type="text" id="message-input" class="form-control" placeholder="Ketik pesan..." autocomplete="off">
            <button onclick="sendMessage()" class="btn btn-success">Kirim ‚û§</button>
        </div>
    </div>

    <script type="module">
        // Kita pakai import dari URL (CDN) supaya tidak perlu install npm/nodejs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- KONFIGURASI KAMU (SUDAH SAYA MASUKKAN) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5o4FTyWTFIbdvpO2-vfN2_Mf750GtiXM",
            authDomain: "chatting-22bb9.firebaseapp.com",
            projectId: "chatting-22bb9",
            storageBucket: "chatting-22bb9.firebasestorage.app",
            messagingSenderId: "540910795541",
            appId: "1:540910795541:web:d0fdb25b2e2f928c36c71c",
            measurementId: "G-DSFN1PR1WV"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // -- LOGIC CHAT DIMULAI --

        // 1. Buat ID Pengguna Sementara (Disimpan di browser)
        let myId = localStorage.getItem('my_chat_id');
        if (!myId) {
            myId = Math.random().toString(36).substring(7);
            localStorage.setItem('my_chat_id', myId);
        }

        // 2. Cek apakah ada ?room=XYZ di URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');

        // Jika BELUM ada Room ID -> Tampilkan Landing Page
        if (!roomId) {
            document.getElementById('landing-page').style.display = 'flex';
        } 
        // Jika SUDAH ada Room ID -> Tampilkan Chat
        else {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('chat-container').style.display = 'block';
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('top-bar').style.display = 'block';
            document.getElementById('room-id-display').innerText = "ID: " + roomId;

            // Listen Data dari Firebase (Realtime)
            const q = query(collection(db, "rooms", roomId, "messages"), orderBy("createdAt", "asc"));
            
            onSnapshot(q, (snapshot) => {
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML = ""; // Reset tampilan
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const isMe = data.senderId === myId;
                    
                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'me' : 'them'}`;
                    
                    // Tampilkan Text
                    div.innerHTML = `
                        ${data.text}
                        <small>${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</small>
                    `;
                    
                    chatContainer.appendChild(div);
                });

                // Auto scroll ke paling bawah
                window.scrollTo(0, document.body.scrollHeight);
            });
        }

        // Fungsi Kirim Pesan
        window.sendMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (text && roomId) {
                try {
                    await addDoc(collection(db, "rooms", roomId, "messages"), {
                        text: text,
                        senderId: myId, // Biar tau ini chat siapa
                        createdAt: serverTimestamp()
                    });
                    input.value = ""; // Hapus teks di input
                    input.focus();
                } catch (e) {
                    console.error("Error kirim pesan: ", e);
                    alert("Gagal kirim pesan. Cek konsol.");
                }
            }
        };

        // Supaya bisa tekan Enter untuk kirim
        document.getElementById('message-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") window.sendMessage();
        });

        // Fungsi Buat Room Baru
        window.createRoom = () => {
            const newId = Math.random().toString(36).substring(2, 8); // Random ID 6 karakter
            window.location.search = `?room=${newId}`;
        };

        // Fungsi Copy Link
        window.copyLink = () => {
            navigator.clipboard.writeText(window.location.href);
            alert("Link tersalin! Kirim ke temanmu sekarang.");
        };
    </script>
</body>
</html>
