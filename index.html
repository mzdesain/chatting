<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WA Pro Clone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root { --wa-primary: #008069; --wa-bg: #efeae2; --wa-light: #fff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: #d1d7db; font-family: Helvetica, Arial, sans-serif; margin: 0; height: 100dvh; overflow: hidden; display: flex; justify-content: center; }
        
        #app-frame { width: 100%; height: 100%; background-color: #fff; display: flex; flex-direction: column; position: relative; max-width: 450px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* LOGIN */
        .full-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .login-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; font-size: 16px; }
        .btn-primary-wa { width: 100%; background: var(--wa-primary); color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; }

        /* HOME */
        #home-screen { display: none; flex-direction: column; height: 100%; }
        .home-header { background: var(--wa-primary); color: white; padding: 15px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .search-bar { width: 100%; padding: 8px 15px; border-radius: 8px; border: none; outline: none; font-size: 14px; }
        
        .chat-list { flex: 1; overflow-y: auto; background: white; }
        .chat-item { display: flex; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; align-items: center; user-select: none; }
        .chat-item:active { background: #e0e0e0; }
        .chat-avatar { width: 50px; height: 50px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; color: #555; font-size: 24px; margin-right: 15px; flex-shrink: 0; }
        .fab-new { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--wa-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }

        /* CHAT ROOM */
        #chat-screen { display: none; flex-direction: column; height: 100%; background: var(--wa-bg); position: relative; z-index: 50; }
        .chat-header { background: var(--wa-primary); color: white; padding: 10px; display: flex; align-items: center; z-index: 10; }
        .input-area { background: #f0f2f5; padding: 5px 10px; display: flex; align-items: center; z-index: 10; min-height: 60px; }
        .input-field { flex: 1; border-radius: 20px; border: none; padding: 10px 15px; font-size: 15px; margin: 0 5px; outline: none; }
        
        #messages-area { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.9; }
        .message { max-width: 75%; padding: 6px 8px; margin-bottom: 4px; border-radius: 7.5px; font-size: 14.2px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); display: flex; flex-wrap: wrap; background: white; }
        .message.me { background-color: #d9fdd3; align-self: flex-end; border-top-right-radius: 0; }
        .message.them { background-color: #fff; align-self: flex-start; border-top-left-radius: 0; }
        .msg-meta { margin-left: auto; font-size: 10px; color: #667; display: flex; align-items: center; padding-top: 5px; padding-left: 5px; }
        .media-content { width: 100%; border-radius: 5px; margin-bottom: 5px; }

        /* CALL UI */
        .call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; flex-direction: column; align-items: center; justify-content: center; }
        #incoming-overlay { background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('https://i.pinimg.com/originals/48/28/e0/4828e05a7069d8f9502b90ba4d338981.jpg'); background-size: cover; padding-top: 80px; justify-content: flex-start; color: white; }
        
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; bottom: 120px; right: 20px; width: 90px; height: 130px; background: #333; border-radius: 8px; object-fit: cover; transform: scaleX(-1); z-index: 100000; transition: all 0.3s; }
        
        .active-controls { position: absolute; bottom: 30px; display: flex; gap: 20px; z-index: 100001; }
        .ctrl-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; }
        .ctrl-btn.hangup { background: red; width: 60px; height: 60px; font-size: 24px; }
        
        /* CONFIRM MODAL */
        #confirm-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 20px; border-radius: 10px; width: 80%; max-width: 300px; text-align: center; }
    </style>
</head>
<body>
    <input type="file" id="file-input" hidden accept="image/*,video/mp4,video/webm">
    <audio id="ringtone" loop src="https://upload.wikimedia.org/wikipedia/commons/e/e6/Bell_ring_effect.ogg"></audio>

    <div id="login-screen" class="full-overlay">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="80" class="mb-4">
        <h4>Verifikasi Nomor</h4>
        <div id="phone-step" style="width:100%">
            <p class="text-muted small">Contoh: 08123456789</p>
            <input type="tel" id="phone-number" class="login-input" placeholder="08xxxxxxxx">
            <div id="recaptcha-container"></div>
            <button class="btn-primary-wa" onclick="sendOTP()">Kirim Kode</button>
        </div>
        <div id="otp-step" style="display:none; width:100%">
            <input type="number" id="otp-code" class="login-input" placeholder="Kode OTP">
            <button class="btn-primary-wa" onclick="verifyOTP()">Verifikasi</button>
        </div>
    </div>

    <div id="profile-screen" class="full-overlay" style="display:none;">
        <h4>Info Profil</h4>
        <div style="width:100px; height:100px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; margin:20px 0;"><i class="bi bi-person"></i></div>
        <input type="text" id="username-input" class="login-input" placeholder="Nama Anda">
        <button class="btn-primary-wa" onclick="saveProfile()">Simpan</button>
    </div>

    <div id="app-frame" style="display:none;">
        <div id="home-screen">
            <div class="home-header">
                <div class="header-top">
                    <span style="font-weight:bold; font-size:20px;">WhatsApp</span>
                    <i class="bi bi-three-dots-vertical" onclick="logout()" style="cursor:pointer;"></i>
                </div>
                <input type="text" id="search-input" class="search-bar" placeholder="Cari nama..." onkeyup="filterChats()">
            </div>
            
            <div id="chat-list-container" class="chat-list"></div>
            
            <div class="fab-new" onclick="promptNewChat()"><i class="bi bi-chat-text-fill"></i></div>
        </div>

        <div id="chat-screen">
            <div class="chat-header">
                <i class="bi bi-arrow-left" onclick="closeChat()" style="font-size:20px; margin-right:10px; cursor:pointer;"></i>
                <div style="width:35px; height:35px; background:#ccc; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:10px;"><i class="bi bi-person-fill"></i></div>
                <div style="flex:1;">
                    <div style="font-weight:600;" id="chat-title-name">User</div>
                </div>
                <div style="display:flex; gap:20px;">
                    <i class="bi bi-camera-video-fill" onclick="startCall('video')" style="font-size:20px; cursor:pointer;"></i>
                    <i class="bi bi-telephone-fill" onclick="startCall('voice')" style="font-size:20px; cursor:pointer;"></i>
                </div>
            </div>
            <div id="messages-area"></div>
            <div class="input-area">
                <button class="btn-icon" onclick="document.getElementById('file-input').click()"><i class="bi bi-paperclip" style="transform: rotate(45deg);"></i></button>
                <input type="text" id="msg-input" class="input-field" placeholder="Ketik pesan" autocomplete="off">
                <button class="btn-icon" style="background:var(--wa-primary); color:white; border-radius:50%; width:40px; height:40px;" onclick="sendMsg()"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>

    <div id="incoming-overlay" class="call-overlay">
        <div style="width:120px; height:120px; background:#ccc; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:50px; margin-bottom:20px;"><i class="bi bi-person-fill"></i></div>
        <h2 id="inc-caller-name">...</h2>
        <p id="inc-type">WhatsApp Call...</p>
        <div style="position:absolute; bottom:50px; width:100%; display:flex; justify-content:space-around;">
            <button onclick="rejectCall()" style="width:65px; height:65px; border-radius:50%; background:#d50000; color:white; border:none; font-size:28px;"><i class="bi bi-telephone-x-fill"></i></button>
            <button onclick="answerCall()" style="width:65px; height:65px; border-radius:50%; background:#00c853; color:white; border:none; font-size:28px;"><i class="bi bi-telephone-fill"></i></button>
        </div>
    </div>

    <div id="active-overlay" class="call-overlay">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="active-controls">
            <button class="ctrl-btn" onclick="switchCam()"><i class="bi bi-arrow-repeat"></i></button>
            <button class="ctrl-btn" id="btn-mic" onclick="toggleMic()"><i class="bi bi-mic-fill"></i></button>
            <button class="ctrl-btn hangup" onclick="hangup()"><i class="bi bi-telephone-x-fill"></i></button>
            <button class="ctrl-btn" id="btn-cam" onclick="toggleCam()"><i class="bi bi-camera-video-fill"></i></button>
        </div>
    </div>

    <div id="confirm-modal">
        <div class="modal-box">
            <h5>Hapus Chat?</h5>
            <p class="small text-muted">Seluruh riwayat pesan dengan pengguna ini akan dihapus.</p>
            <div class="d-flex gap-2 justify-content-center mt-3">
                <button class="btn btn-secondary w-50" onclick="document.getElementById('confirm-modal').style.display='none'">Batal</button>
                <button class="btn btn-danger w-50" onclick="executeDeleteChat()">Hapus</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5o4FTyWTFIbdvpO2-vfN2_Mf750GtiXM",
            authDomain: "chatting-22bb9.firebaseapp.com",
            projectId: "chatting-22bb9",
            storageBucket: "chatting-22bb9.firebasestorage.app",
            messagingSenderId: "540910795541",
            appId: "1:540910795541:web:d0fdb25b2e2f928c36c71c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentChatId = null;
        let currentPartnerId = null;
        let confirmResult = null;
        let chatToDelete = null;

        // --- AUTH & PHONE FORMAT ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                const uDoc = await getDoc(doc(db, "users", user.uid));
                if (uDoc.exists()) showHomeScreen(); else document.getElementById('profile-screen').style.display = 'flex';
            } else {
                document.getElementById('app-frame').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                if(!window.recaptchaVerifier) window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {'size':'invisible'}, auth);
            }
        });

        // Format 08 -> +628
        function formatPhone(num) {
            if(num.startsWith('08')) return '+62' + num.substring(1);
            return num;
        }

        window.sendOTP = () => {
            let phone = document.getElementById('phone-number').value.trim();
            if(!phone) return alert("Masukkan nomor");
            phone = formatPhone(phone);
            
            signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
                .then((res) => { confirmResult = res; document.getElementById('phone-step').style.display='none'; document.getElementById('otp-step').style.display='block'; })
                .catch((e) => alert("Error: " + e.message));
        };

        window.verifyOTP = () => {
            const code = document.getElementById('otp-code').value;
            confirmResult.confirm(code).catch(()=>alert("Kode salah"));
        };

        window.saveProfile = async () => {
            const name = document.getElementById('username-input').value;
            if(!name) return alert("Nama wajib");
            await setDoc(doc(db, "users", currentUser.uid), { uid: currentUser.uid, phone: currentUser.phoneNumber, displayName: name, nameLower: name.toLowerCase() });
            document.getElementById('profile-screen').style.display = 'none';
            showHomeScreen();
        };

        window.logout = () => signOut(auth).then(()=>location.reload());

        // --- HOME SCREEN & SEARCH ---
        function showHomeScreen() {
            document.getElementById('app-frame').style.display = 'flex';
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('chat-screen').style.display = 'none';
            loadChatList();
            listenCalls();
        }

        function loadChatList() {
            const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), orderBy("lastUpdated", "desc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('chat-list-container');
                list.innerHTML = "";
                snap.forEach(async (d) => {
                    const data = d.data();
                    const partnerId = data.participants.find(id => id !== currentUser.uid);
                    const partnerDoc = await getDoc(doc(db, "users", partnerId));
                    const name = partnerDoc.exists() ? partnerDoc.data().displayName : "User";
                    
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.setAttribute('data-name', name.toLowerCase()); // Untuk Search
                    item.innerHTML = `
                        <div class="chat-avatar"><i class="bi bi-person-fill"></i></div>
                        <div style="flex:1">
                            <div style="font-weight:bold">${name}</div>
                            <div style="font-size:13px; color:#666">${data.lastMessage || ''}</div>
                        </div>
                        <div style="font-size:11px; color:#999">${data.lastUpdated ? data.lastUpdated.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : ''}</div>
                    `;
                    // Klik untuk buka chat
                    item.onclick = () => openChat(d.id, partnerId, name);
                    
                    // Long Press untuk Hapus
                    let timer;
                    const startPress = () => { timer = setTimeout(() => { chatToDelete = d.id; document.getElementById('confirm-modal').style.display='flex'; }, 800); };
                    const endPress = () => clearTimeout(timer);
                    item.addEventListener('touchstart', startPress); item.addEventListener('touchend', endPress);
                    item.addEventListener('mousedown', startPress); item.addEventListener('mouseup', endPress);

                    list.appendChild(item);
                });
            });
        }

        // Fitur Pencarian
        window.filterChats = () => {
            const query = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('.chat-item');
            items.forEach(item => {
                const name = item.getAttribute('data-name');
                item.style.display = name.includes(query) ? 'flex' : 'none';
            });
        };

        // Hapus Chat
        window.executeDeleteChat = async () => {
            if(chatToDelete) {
                await deleteDoc(doc(db, "chats", chatToDelete));
                document.getElementById('confirm-modal').style.display='none';
            }
        };

        window.promptNewChat = async () => {
            let phone = prompt("Masukkan Nomor HP Teman (08...):");
            if(!phone) return;
            phone = formatPhone(phone);
            
            const q = query(collection(db, "users"), where("phone", "==", phone));
            const snap = await getDocs(q);
            if(snap.empty) return alert("Nomor belum terdaftar di aplikasi ini.");
            
            const target = snap.docs[0].data();
            if(target.uid === currentUser.uid) return alert("Tidak bisa chat diri sendiri");

            const chatId = [currentUser.uid, target.uid].sort().join("_");
            const chatRef = doc(db, "chats", chatId);
            const exists = (await getDoc(chatRef)).exists();
            
            if(!exists) {
                await setDoc(chatRef, { participants: [currentUser.uid, target.uid], lastMessage: "", lastUpdated: serverTimestamp() });
            }
            openChat(chatId, target.uid, target.displayName);
        };

        // --- CHAT ROOM ---
        function openChat(id, partnerId, name) {
            currentChatId = id;
            currentPartnerId = partnerId;
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-title-name').innerText = name;
            
            const q = query(collection(db, "chats", id, "messages"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snap) => {
                const area = document.getElementById('messages-area');
                area.innerHTML = "";
                snap.forEach((d) => {
                    const msg = d.data();
                    const isMe = msg.senderId === currentUser.uid;
                    if(!isMe && !msg.read) updateDoc(doc(db, "chats", id, "messages", d.id), {read:true});

                    const div = document.createElement('div');
                    div.className = `message ${isMe?'me':'them'}`;
                    let content = `<span>${msg.text}</span>`;
                    if(msg.media) {
                        content = (msg.type === 'video') ? `<video src="${msg.media}" controls class="media-content"></video> ${msg.text}` : `<img src="${msg.media}" class="media-content"> ${msg.text}`;
                    }
                    const tick = isMe ? `<i class="bi bi-check-all msg-tick ${msg.read?'read':''}"></i>` : '';
                    div.innerHTML = `${content} <div class="msg-meta">${msg.createdAt?.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})||''} ${tick}</div>`;
                    area.appendChild(div);
                });
                area.scrollTop = area.scrollHeight;
            });
        }

        window.closeChat = () => {
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
            currentChatId = null;
        };

        window.sendMsg = async (media=null, type='text') => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if((text || media) && currentChatId) {
                input.value = "";
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    text, media, type, senderId: currentUser.uid, createdAt: serverTimestamp(), read: false
                });
                await updateDoc(doc(db, "chats", currentChatId), {
                    lastMessage: type==='text'?text:(type==='image'?'ðŸ“· Foto':'ðŸŽ¥ Video'), lastUpdated: serverTimestamp()
                });
            }
        };

        document.getElementById('file-input').addEventListener('change', (e) => {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
                if(f.size > 3*1024*1024) return alert("Max 3MB");
                if(f.type.startsWith('video')) sendMsg(ev.target.result, 'video');
                else {
                    const img = new Image(); img.onload = () => {
                        const c = document.createElement('canvas'); const x = c.getContext('2d');
                        const w = 600; const h = img.height * (w/img.width);
                        c.width = w; c.height = h; x.drawImage(img,0,0,w,h);
                        sendMsg(c.toDataURL('image/jpeg',0.7), 'image');
                    }; img.src = ev.target.result;
                }
            }; r.readAsDataURL(f);
        });
        document.getElementById('msg-input').addEventListener("keypress", (e)=>{ if(e.key==="Enter") sendMsg(); });

        // --- CALLING (WEBRTC) ---
        let pc, localStream, callDocRef, incomingData;
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let currentFacingMode = 'user';

        function listenCalls() {
            const q = query(collection(db, "calls"), where("calleeId", "==", currentUser.uid), where("status", "==", "offering"));
            onSnapshot(q, async (snap) => {
                snap.docChanges().forEach(async (change) => {
                    if(change.type === 'added') {
                        const data = change.doc.data();
                        incomingData = { id: change.doc.id, ...data };
                        const callerDoc = await getDoc(doc(db, "users", data.callerId));
                        document.getElementById('inc-caller-name').innerText = callerDoc.exists() ? callerDoc.data().displayName : "Unknown";
                        document.getElementById('inc-type').innerText = `WhatsApp ${data.type} Call`;
                        document.getElementById('incoming-overlay').style.display = 'flex';
                        document.getElementById('ringtone').play().catch(()=>{});
                    }
                });
            });
        }

        window.startCall = async (type) => {
            if(!currentPartnerId) return;
            document.getElementById('active-overlay').style.display = 'flex';
            await initPC(); await getStream(type);
            const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            
            callDocRef = doc(collection(db, "calls"));
            await setDoc(callDocRef, { callerId: currentUser.uid, calleeId: currentPartnerId, offer: {type:offer.type, sdp:offer.sdp}, type, status: 'offering' });

            onSnapshot(callDocRef, (s) => {
                const d = s.data();
                if(!d) { cleanupCall(); return; } // Dokumen dihapus = Tutup
                if(d.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                if(d.status === 'rejected') { alert("Ditolak"); hangup(); }
            });
        };

        window.answerCall = async () => {
            document.getElementById('incoming-overlay').style.display = 'none';
            document.getElementById('ringtone').pause();
            document.getElementById('active-overlay').style.display = 'flex';
            
            callDocRef = doc(db, "calls", incomingData.id);
            await initPC(); await getStream(incomingData.type);
            await pc.setRemoteDescription(new RTCSessionDescription(incomingData.offer));
            const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
            await updateDoc(callDocRef, { answer: {type:answer.type, sdp:answer.sdp}, status: 'connected' });
            
            // Listener untuk mematikan jika penelpon tutup
            onSnapshot(callDocRef, (s) => { if(!s.exists()) cleanupCall(); });
        };

        window.rejectCall = async () => {
            document.getElementById('incoming-overlay').style.display = 'none';
            document.getElementById('ringtone').pause();
            await updateDoc(doc(db, "calls", incomingData.id), { status: 'rejected' });
        };

        window.hangup = async () => {
            if(callDocRef) await deleteDoc(callDocRef); // Hapus dokumen -> Trigger listener di lawan -> cleanupCall()
            cleanupCall();
        };

        function cleanupCall() {
            if(pc) pc.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('active-overlay').style.display = 'none';
            document.getElementById('incoming-overlay').style.display = 'none';
            document.getElementById('ringtone').pause();
        }

        async function initPC() {
            pc = new RTCPeerConnection(servers);
            pc.onicecandidate = e => { if(e.candidate && callDocRef) addDoc(collection(callDocRef, "candidates"), e.candidate.toJSON()); };
            pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];
            
            setTimeout(() => {
                if(!callDocRef) return;
                const col = collection(callDocRef, "candidates");
                onSnapshot(col, s => { s.docChanges().forEach(c => { if(c.type==='added') pc.addIceCandidate(new RTCIceCandidate(c.doc.data())).catch(()=>{}); }); });
            }, 1000);
        }

        async function getStream(type) {
            const constraints = { audio: true, video: type === 'video' ? { facingMode: currentFacingMode } : false };
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            if(type==='video') document.getElementById('localVideo').srcObject = localStream;
        }

        window.switchCam = async () => {
            if (!localStream) return;
            currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
            // Stop video lama
            localStream.getVideoTracks().forEach(t => t.stop());
            
            const constraints = { audio: true, video: { facingMode: currentFacingMode } };
            const newStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            // Ganti track di PeerConnection
            const videoTrack = newStream.getVideoTracks()[0];
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if(sender) sender.replaceTrack(videoTrack);
            
            // Update local view
            document.getElementById('localVideo').srcObject = newStream;
            
            // Pindahkan audio track dari stream lama ke stream baru object (biar rapi)
            const audioTrack = localStream.getAudioTracks()[0];
            newStream.addTrack(audioTrack);
            localStream = newStream;
        };

        window.toggleMic = () => { localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; };
        window.toggleCam = () => { localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; };
    </script>
</body>
</html>
