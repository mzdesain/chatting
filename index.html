<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WA Clone Full</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root { --wa-primary: #008069; --wa-bg: #efeae2; --wa-chat-list: #ffffff; }
        * { box-sizing: border-box; }
        body { background-color: #d1d7db; font-family: Helvetica, Arial, sans-serif; margin: 0; height: 100dvh; overflow: hidden; display: flex; justify-content: center; }
        
        #app-frame { width: 100%; height: 100%; background-color: #fff; display: flex; flex-direction: column; position: relative; max-width: 450px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* --- LAYAR LOGIN & PROFIL --- */
        .full-screen-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .wa-logo { width: 80px; margin-bottom: 30px; }
        .login-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 15px; font-size: 16px; }
        .btn-primary-wa { width: 100%; background: var(--wa-primary); color: white; border: none; padding: 12px; border-radius: 25px; font-weight: bold; margin-top: 10px; }

        /* --- LAYAR HOME (CHAT LIST) --- */
        #home-screen { display: none; flex-direction: column; height: 100%; }
        .home-header { background: var(--wa-primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; }
        .chat-list { flex: 1; overflow-y: auto; background: white; }
        .chat-item { display: flex; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; align-items: center; }
        .chat-item:hover { background: #f5f5f5; }
        .chat-avatar { width: 50px; height: 50px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; color: #555; font-size: 24px; margin-right: 15px; }
        .chat-info { flex: 1; text-align: left; }
        .chat-name { font-weight: bold; font-size: 16px; color: #111; }
        .chat-preview { font-size: 14px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .chat-time { font-size: 11px; color: #999; }
        .fab-new-chat { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--wa-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }

        /* --- LAYAR CHAT ROOM --- */
        #chat-screen { display: none; flex-direction: column; height: 100%; background: var(--wa-bg); position: relative; z-index: 50; }
        .chat-bg-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.4; z-index: 0; pointer-events: none; }
        .chat-header { background: var(--wa-primary); color: white; padding: 10px 10px; display: flex; align-items: center; z-index: 10; }
        .back-btn { margin-right: 10px; font-size: 20px; cursor: pointer; }
        .header-title { flex: 1; margin-left: 10px; }
        .header-icons i { font-size: 20px; margin-left: 20px; cursor: pointer; }
        
        #messages-area { flex: 1; overflow-y: auto; padding: 15px; z-index: 5; display: flex; flex-direction: column; }
        .message { max-width: 75%; padding: 6px 8px; margin-bottom: 4px; border-radius: 7.5px; font-size: 14.2px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); position: relative; display: flex; flex-wrap: wrap; }
        .message.me { background-color: #d9fdd3; align-self: flex-end; border-top-right-radius: 0; }
        .message.them { background-color: #fff; align-self: flex-start; border-top-left-radius: 0; }
        .msg-meta { margin-left: auto; font-size: 10px; color: #667; display: flex; align-items: center; padding-top: 5px; padding-left: 5px; }
        .msg-tick { font-size: 14px; margin-left: 3px; color: #888; }
        .msg-tick.read { color: #53bdeb; }
        .media-content { width: 100%; border-radius: 5px; margin-bottom: 5px; }

        .input-area { background: #f0f2f5; padding: 5px 10px; display: flex; align-items: center; z-index: 10; min-height: 60px; }
        .input-field { flex: 1; border-radius: 20px; border: none; padding: 10px 15px; font-size: 15px; margin: 0 5px; outline: none; }
        .btn-icon { border: none; background: none; font-size: 24px; color: #54656f; padding: 0 8px; }

        /* --- CALL OVERLAYS --- */
        .call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; flex-direction: column; align-items: center; justify-content: center; }
        #incoming-overlay { background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url('https://i.pinimg.com/originals/48/28/e0/4828e05a7069d8f9502b90ba4d338981.jpg'); background-size: cover; padding-top: 80px; justify-content: flex-start; color: white; }
        .caller-avatar-lg { width: 120px; height: 120px; border-radius: 50%; background: #ccc; display:flex; align-items:center; justify-content:center; font-size: 50px; margin-bottom: 20px; }
        .call-btns { position: absolute; bottom: 50px; width: 100%; display: flex; justify-content: space-around; }
        .btn-call-action { width: 65px; height: 65px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; cursor: pointer; }
        .btn-accept { background: #00c853; animation: pulse 1.5s infinite; }
        .btn-reject { background: #d50000; }
        
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; bottom: 120px; right: 20px; width: 90px; height: 130px; background: #333; border-radius: 8px; object-fit: cover; transform: scaleX(-1); z-index: 100000; }
        .active-controls { position: absolute; bottom: 30px; display: flex; gap: 20px; z-index: 100001; }
        .ctrl-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; }
        .ctrl-btn.hangup { background: red; width: 60px; height: 60px; font-size: 24px; }
        .ctrl-btn.off { background: white; color: black; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <input type="file" id="file-input" hidden accept="image/*,video/mp4,video/webm">
    <audio id="ringtone" loop src="https://upload.wikimedia.org/wikipedia/commons/e/e6/Bell_ring_effect.ogg"></audio>

    <div id="login-screen" class="full-screen-overlay">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="wa-logo">
        <h4>Selamat Datang di WA Clone</h4>
        <div id="phone-step" style="width:100%">
            <p class="text-muted small">Masukkan No. HP (+62...)</p>
            <input type="tel" id="phone-number" class="login-input" placeholder="+62812xxxx" value="+62">
            <div id="recaptcha-container"></div>
            <button class="btn-primary-wa" onclick="sendOTP()">Lanjut</button>
        </div>
        <div id="otp-step" style="display:none; width:100%">
            <p class="text-muted small">Masukkan 6 digit kode SMS</p>
            <input type="number" id="otp-code" class="login-input" placeholder="123456">
            <button class="btn-primary-wa" onclick="verifyOTP()">Verifikasi</button>
        </div>
    </div>

    <div id="profile-screen" class="full-screen-overlay" style="display:none;">
        <h4>Info Profil</h4>
        <p class="text-muted small">Masukkan nama agar teman bisa mengenali Anda</p>
        <div class="wa-avatar" style="width:100px; height:100px; font-size:40px; margin: 20px auto;"><i class="bi bi-person"></i></div>
        <input type="text" id="username-input" class="login-input" placeholder="Nama Anda (Wajib)">
        <button class="btn-primary-wa" onclick="saveProfile()">Simpan & Masuk</button>
    </div>

    <div id="app-frame" style="display:none;">
        
        <div id="home-screen">
            <div class="home-header">
                <span style="font-weight:bold; font-size:20px;">WhatsApp</span>
                <div style="display:flex; gap:15px;">
                    <i class="bi bi-search"></i>
                    <i class="bi bi-three-dots-vertical" onclick="logout()"></i>
                </div>
            </div>
            <div id="chat-list-container" class="chat-list">
                </div>
            <div class="fab-new-chat" onclick="promptNewChat()">
                <i class="bi bi-chat-text-fill"></i>
            </div>
        </div>

        <div id="chat-screen">
            <div class="chat-bg-img"></div>
            <div class="chat-header">
                <i class="bi bi-arrow-left back-btn" onclick="closeChat()"></i>
                <div class="wa-avatar" style="width:35px; height:35px; font-size:18px;"><i class="bi bi-person-fill"></i></div>
                <div class="header-title">
                    <div style="font-weight:600; font-size:15px;" id="chat-title-name">Nama Kontak</div>
                    <div style="font-size:11px; opacity:0.8;" id="chat-subtitle">Online</div>
                </div>
                <div class="header-icons">
                    <i class="bi bi-camera-video-fill" onclick="startCall('video')"></i>
                    <i class="bi bi-telephone-fill" onclick="startCall('voice')"></i>
                </div>
            </div>
            
            <div id="messages-area"></div>
            
            <div class="input-area">
                <button class="btn-icon"><i class="bi bi-emoji-smile"></i></button>
                <button class="btn-icon" onclick="document.getElementById('file-input').click()"><i class="bi bi-paperclip" style="transform: rotate(45deg);"></i></button>
                <input type="text" id="msg-input" class="input-field" placeholder="Ketik pesan" autocomplete="off">
                <button class="btn-icon" style="background:var(--wa-primary); color:white; border-radius:50%; width:40px; height:40px;" onclick="sendMsg()"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>

    </div>

    <div id="incoming-overlay" class="call-overlay">
        <div class="caller-avatar-lg"><i class="bi bi-person-fill"></i></div>
        <h2 id="inc-caller-name">...</h2>
        <p id="inc-type">WhatsApp Call...</p>
        <div class="call-btns">
            <button class="btn-call-action btn-reject" onclick="rejectCall()"><i class="bi bi-telephone-x-fill"></i></button>
            <button class="btn-call-action btn-accept" onclick="answerCall()"><i class="bi bi-telephone-fill"></i></button>
        </div>
    </div>

    <div id="active-overlay" class="call-overlay">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="active-controls">
            <button class="ctrl-btn" onclick="switchCam()"><i class="bi bi-arrow-repeat"></i></button>
            <button class="ctrl-btn" id="btn-mic" onclick="toggleMic()"><i class="bi bi-mic-fill"></i></button>
            <button class="ctrl-btn hangup" onclick="hangup()"><i class="bi bi-telephone-x-fill"></i></button>
            <button class="ctrl-btn" id="btn-cam" onclick="toggleCam()"><i class="bi bi-camera-video-fill"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // --- 1. CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5o4FTyWTFIbdvpO2-vfN2_Mf750GtiXM",
            authDomain: "chatting-22bb9.firebaseapp.com",
            projectId: "chatting-22bb9",
            storageBucket: "chatting-22bb9.firebasestorage.app",
            messagingSenderId: "540910795541",
            appId: "1:540910795541:web:d0fdb25b2e2f928c36c71c"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentChatId = null;
        let currentChatPartnerId = null;
        let confirmationResult = null;

        // --- 2. AUTH & PROFILE FLOW ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                // Cek apakah user sudah punya profil
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    showHomeScreen();
                } else {
                    document.getElementById('profile-screen').style.display = 'flex';
                }
            } else {
                document.getElementById('app-frame').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                if(!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {'size': 'normal'}, auth);
                    window.recaptchaVerifier.render();
                }
            }
        });

        window.sendOTP = () => {
            const phone = document.getElementById('phone-number').value;
            signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
                .then((res) => { confirmationResult = res; document.getElementById('phone-step').style.display='none'; document.getElementById('otp-step').style.display='block'; })
                .catch((err) => alert("Error: " + err.message));
        };
        window.verifyOTP = () => {
            const code = document.getElementById('otp-code').value;
            confirmationResult.confirm(code).catch((err) => alert("Kode Salah"));
        };
        window.saveProfile = async () => {
            const name = document.getElementById('username-input').value;
            if(!name) return alert("Nama wajib diisi");
            await setDoc(doc(db, "users", currentUser.uid), {
                uid: currentUser.uid,
                phone: currentUser.phoneNumber,
                displayName: name,
                photoURL: null
            });
            document.getElementById('profile-screen').style.display = 'none';
            showHomeScreen();
        };
        window.logout = () => signOut(auth).then(()=>location.reload());

        // --- 3. HOME SCREEN (CHAT LIST) ---
        function showHomeScreen() {
            document.getElementById('app-frame').style.display = 'flex';
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('chat-screen').style.display = 'none';
            loadChatList();
            listenIncomingCallsGlobal(); // Global listener untuk telpon masuk
        }

        function loadChatList() {
            // Query semua chat dimana user ini adalah peserta
            const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid), orderBy("lastUpdated", "desc"));
            onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('chat-list-container');
                listContainer.innerHTML = "";
                snapshot.forEach(async (docSnap) => {
                    const chatData = docSnap.data();
                    const chatId = docSnap.id;
                    
                    // Cari ID lawan bicara
                    const partnerId = chatData.participants.find(uid => uid !== currentUser.uid);
                    
                    // Ambil data profil lawan bicara
                    const partnerDoc = await getDoc(doc(db, "users", partnerId));
                    const partnerName = partnerDoc.exists() ? partnerDoc.data().displayName : partnerId;
                    
                    // Render Item List
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.innerHTML = `
                        <div class="chat-avatar"><i class="bi bi-person-fill"></i></div>
                        <div class="chat-info">
                            <div class="chat-name">${partnerName}</div>
                            <div class="chat-preview">${chatData.lastMessage || "Belum ada pesan"}</div>
                        </div>
                        <div class="chat-time">${chatData.lastUpdated ? chatData.lastUpdated.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</div>
                    `;
                    item.onclick = () => openChat(chatId, partnerId, partnerName);
                    listContainer.appendChild(item);
                });
            });
        }

        window.promptNewChat = async () => {
            const phone = prompt("Masukkan Nomor HP Teman (+62...):");
            if(!phone) return;
            
            // Cari user berdasarkan No HP
            const q = query(collection(db, "users"), where("phone", "==", phone));
            const querySnap = await getDocs(q);
            
            if(querySnap.empty) {
                alert("Nomor belum terdaftar di aplikasi ini.");
                return;
            }
            
            const targetUser = querySnap.docs[0].data();
            if(targetUser.uid === currentUser.uid) return alert("Tidak bisa chat diri sendiri");

            // Cek apakah chat sudah ada?
            // (Logic sederhana: create ID unik gabungan UID1_UID2 yang di-sort)
            const sortedIds = [currentUser.uid, targetUser.uid].sort();
            const chatId = sortedIds.join("_");
            
            // Simpan dokumen chat jika belum ada
            const chatRef = doc(db, "chats", chatId);
            const chatSnap = await getDoc(chatRef);
            
            if(!chatSnap.exists()) {
                await setDoc(chatRef, {
                    participants: [currentUser.uid, targetUser.uid],
                    lastMessage: "",
                    lastUpdated: serverTimestamp()
                });
            }
            
            openChat(chatId, targetUser.uid, targetUser.displayName);
        };

        // --- 4. CHAT ROOM LOGIC ---
        function openChat(chatId, partnerId, partnerName) {
            currentChatId = chatId;
            currentChatPartnerId = partnerId;
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-title-name').innerText = partnerName;
            
            // Load Messages
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("createdAt", "asc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-area');
                container.innerHTML = "";
                snapshot.forEach((docSnap) => {
                    const msg = docSnap.data();
                    const isMe = msg.senderId === currentUser.uid;
                    
                    // Mark as read
                    if(!isMe && !msg.read) updateDoc(doc(db, "chats", chatId, "messages", docSnap.id), {read: true});

                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'me' : 'them'}`;
                    
                    let content = `<span>${msg.text}</span>`;
                    if(msg.media) {
                        content = (msg.type === 'video') ? 
                            `<video src="${msg.media}" controls class="media-content"></video> ${msg.text}` : 
                            `<img src="${msg.media}" class="media-content"> ${msg.text}`;
                    }
                    
                    const tickColor = msg.read ? 'read' : '';
                    const tick = isMe ? `<i class="bi bi-check-all msg-tick ${tickColor}"></i>` : '';
                    
                    div.innerHTML = `${content} <div class="msg-meta">${msg.createdAt?.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})||''} ${tick}</div>`;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        window.closeChat = () => {
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
            currentChatId = null;
        };

        window.sendMsg = async (mediaData = null, type = 'text') => {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if ((text || mediaData) && currentChatId) {
                input.value = "";
                await addDoc(collection(db, "chats", currentChatId, "messages"), {
                    text: text, media: mediaData, type: type,
                    senderId: currentUser.uid, createdAt: serverTimestamp(), read: false
                });
                // Update Last Message di Chat List
                await updateDoc(doc(db, "chats", currentChatId), {
                    lastMessage: type === 'text' ? text : (type === 'image' ? 'ðŸ“· Foto' : 'ðŸŽ¥ Video'),
                    lastUpdated: serverTimestamp()
                });
            }
        };

        // File Upload Logic
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                if(file.size > 3 * 1024 * 1024) return alert("Max 3MB");
                if(file.type.startsWith('video')) sendMsg(ev.target.result, 'video');
                else {
                    const img = new Image(); img.onload = () => {
                        const c = document.createElement('canvas'); const ctx = c.getContext("2d");
                        const w = 600; const h = img.height * (w/img.width);
                        c.width = w; c.height = h; ctx.drawImage(img,0,0,w,h);
                        sendMsg(c.toDataURL("image/jpeg",0.7), 'image');
                    }; img.src = ev.target.result;
                }
            }; reader.readAsDataURL(file);
        });

        document.getElementById('msg-input').addEventListener("keypress", (e)=>{ if(e.key==="Enter") sendMsg(); });

        // --- 5. CALLING FEATURE (P2P WEBRTC) ---
        let pc, localStream, callDocRef, incomingData;
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        function listenIncomingCallsGlobal() {
            // Dengarkan koleksi 'calls' global dimana 'calleeId' == Saya
            // Ini agar bisa terima telpon walau sedang tidak buka chat room
            const q = query(collection(db, "calls"), where("calleeId", "==", currentUser.uid), where("status", "==", "offering"));
            onSnapshot(q, async (snapshot) => {
                snapshot.docChanges().forEach(async (change) => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        incomingData = { id: change.doc.id, ...data };
                        
                        // Ambil nama penelpon
                        const callerDoc = await getDoc(doc(db, "users", data.callerId));
                        const callerName = callerDoc.exists() ? callerDoc.data().displayName : "Unknown";
                        
                        document.getElementById('inc-caller-name').innerText = callerName;
                        document.getElementById('inc-type').innerText = `WhatsApp ${data.type} Call`;
                        document.getElementById('incoming-overlay').style.display = 'flex';
                        document.getElementById('ringtone').play().catch(()=>{});
                    }
                });
            });
        }

        window.startCall = async (type) => {
            if(!currentChatPartnerId) return;
            
            document.getElementById('active-overlay').style.display = 'flex';
            await initPC(); await getStream(type);
            const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            
            // Buat Dokumen Call Baru di root collection 'calls'
            const callRef = doc(collection(db, "calls"));
            callDocRef = callRef; // simpan ref
            
            await setDoc(callRef, {
                callerId: currentUser.uid, calleeId: currentChatPartnerId,
                offer: { type: offer.type, sdp: offer.sdp },
                type: type, status: 'offering'
            });

            // Listen Answer
            onSnapshot(callRef, (snap) => {
                const data = snap.data();
                if(data?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                if(data?.status === 'rejected') { alert("Ditolak"); hangup(); }
            });
        };

        window.answerCall = async () => {
            document.getElementById('incoming-overlay').style.display = 'none';
            document.getElementById('ringtone').pause();
            document.getElementById('active-overlay').style.display = 'flex';
            
            callDocRef = doc(db, "calls", incomingData.id);
            await initPC(); await getStream(incomingData.type);
            
            await pc.setRemoteDescription(new RTCSessionDescription(incomingData.offer));
            const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
            
            await updateDoc(callDocRef, { answer: { type: answer.type, sdp: answer.sdp }, status: 'connected' });
        };

        window.rejectCall = async () => {
            document.getElementById('incoming-overlay').style.display = 'none';
            document.getElementById('ringtone').pause();
            await updateDoc(doc(db, "calls", incomingData.id), { status: 'rejected' });
        };

        window.hangup = async () => {
            if(callDocRef) await deleteDoc(callDocRef);
            closeCallUI();
        };

        async function initPC() {
            pc = new RTCPeerConnection(servers);
            pc.onicecandidate = event => { 
                if (event.candidate && callDocRef) {
                    const col = collection(callDocRef, "candidates");
                    addDoc(col, event.candidate.toJSON());
                }
            };
            pc.ontrack = event => document.getElementById('remoteVideo').srcObject = event.streams[0];
            
            // Listen remote candidates (Tunggu callDocRef valid)
            setTimeout(() => {
                if(!callDocRef) return;
                const col = collection(callDocRef, "candidates");
                onSnapshot(col, snap => {
                    snap.docChanges().forEach(change => {
                        if(change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data())).catch(()=>{});
                    });
                });
            }, 1000);
        }

        async function getStream(type) {
            const constraints = { audio: true, video: type === 'video' };
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            if(type==='video') document.getElementById('localVideo').srcObject = localStream;
        }

        function closeCallUI() {
            if(pc) pc.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('active-overlay').style.display = 'none';
            document.getElementById('incoming-overlay').style.display = 'none';
            document.getElementById('ringtone').pause();
        }

        // Controls
        window.toggleMic = () => { localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; document.getElementById('btn-mic').classList.toggle('off'); };
        window.toggleCam = () => { localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; document.getElementById('btn-cam').classList.toggle('off'); };
        window.switchCam = async () => { /* Logic switch cam sama seperti sebelumnya, diadaptasi */ };

    </script>
</body>
</html>
